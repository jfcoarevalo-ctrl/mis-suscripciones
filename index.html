<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SaaS Manager Pro</title>
    
    <!-- Fuentes e Iconos -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Librer铆as: Chart.js, Firebase, Crypto-JS (Encriptaci贸n) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- PWA Config -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f0c29">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            --card-bg: rgba(255, 255, 255, 0.05);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-sec: #a0a0a0;
            --accent-purple: #8e2de2;
            --accent-blue: #4a00e0;
            --status-active: #00d26a;
            --status-trial: #ff9f43;
            --status-cancel: #f73859;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }

        body {
            background: var(--bg-gradient);
            color: var(--text-main);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px; /* Espacio para bot贸n flotante */
        }

        .container { max-width: 800px; margin: 0 auto; }

        /* HEADER & DASHBOARD */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h1 { font-size: 1.5rem; font-weight: 700; background: linear-gradient(to right, #fff, #a0a0a0); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .dashboard {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;
        }
        .dash-card {
            background: var(--card-bg); border: var(--glass-border);
            padding: 15px; border-radius: 15px; backdrop-filter: blur(10px);
            text-align: center;
        }
        .dash-label { font-size: 0.75rem; color: var(--text-sec); text-transform: uppercase; letter-spacing: 1px; }
        .dash-value { font-size: 1.4rem; font-weight: 700; margin-top: 5px; }

        /* LISTA DE SUSCRIPCIONES */
        .sub-list { display: flex; flex-direction: column; gap: 15px; }
        
        .sub-card {
            background: var(--card-bg); border: var(--glass-border);
            padding: 15px; border-radius: 16px;
            display: flex; align-items: center; justify-content: space-between;
            transition: transform 0.2s; cursor: pointer;
        }
        .sub-card:active { transform: scale(0.98); background: rgba(255,255,255,0.1); }

        .sub-icon {
            width: 50px; height: 50px; border-radius: 12px;
            background: #fff; object-fit: cover; padding: 4px;
            margin-right: 15px;
        }

        .sub-info { flex: 1; }
        .sub-name { font-weight: 600; font-size: 1rem; margin-bottom: 2px; }
        .sub-details { font-size: 0.8rem; color: var(--text-sec); display: flex; align-items: center; gap: 8px; }
        
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .st-active { background: var(--status-active); box-shadow: 0 0 5px var(--status-active); }
        .st-trial { background: var(--status-trial); box-shadow: 0 0 5px var(--status-trial); }
        .st-paused { background: var(--text-sec); }

        .sub-cost { text-align: right; font-weight: 600; font-size: 0.95rem; }
        .sub-cycle { font-size: 0.7rem; color: var(--text-sec); display: block; }

        /* BOTN FLOTANTE (FAB) */
        .fab {
            position: fixed; bottom: 25px; right: 25px;
            width: 60px; height: 60px; border-radius: 30px;
            background: linear-gradient(45deg, var(--accent-blue), var(--accent-purple));
            color: white; border: none; font-size: 24px;
            box-shadow: 0 10px 20px rgba(74, 0, 224, 0.4);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            z-index: 100;
        }

        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            z-index: 200; display: none; justify-content: center; align-items: end;
        }
        .modal-content {
            background: #1c1c2e; width: 100%; max-width: 600px;
            border-radius: 25px 25px 0 0; padding: 25px;
            max-height: 90vh; overflow-y: auto;
            border-top: 1px solid rgba(255,255,255,0.2);
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .form-group { margin-bottom: 15px; }
        label { display: block; color: var(--text-sec); font-size: 0.85rem; margin-bottom: 8px; }
        input, select {
            width: 100%; padding: 12px; background: #2c2c44;
            border: 1px solid #444; border-radius: 8px;
            color: white; font-size: 1rem; outline: none;
        }
        input:focus { border-color: var(--accent-purple); }

        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        .btn-save {
            width: 100%; padding: 15px; background: var(--accent-purple);
            color: white; border: none; border-radius: 10px;
            font-weight: 700; font-size: 1rem; margin-top: 10px; cursor: pointer;
        }
        .btn-link { 
            background: #2c2c44; color: var(--accent-blue); width: 100%;
            padding: 12px; border: 1px solid var(--accent-blue); border-radius: 10px;
            margin-top: 10px; cursor: pointer; font-weight: 600;
        }
        .btn-danger { background: transparent; color: var(--status-cancel); border: 1px solid var(--status-cancel); margin-top: 20px; }

        /* Password Reveal */
        .pass-wrapper { position: relative; }
        .pass-btn {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            background: none; border: none; color: var(--accent-purple); cursor: pointer;
        }

        /* Categor铆a Tag */
        .cat-tag { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; background: #333; color: #ccc; margin-left: 5px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <div>
                <h1>Mis Suscripciones</h1>
                <p style="font-size: 0.8rem; color: #a0a0a0;">Control total de tu SaaS</p>
            </div>
            <div id="syncStatus" style="width: 10px; height: 10px; background: grey; border-radius: 50%;"></div>
        </div>

        <!-- Dashboard Financiero -->
        <div class="dashboard">
            <div class="dash-card">
                <div class="dash-label">Mensual</div>
                <div class="dash-value" id="totalMonthly">$0</div>
            </div>
            <div class="dash-card">
                <div class="dash-label">Anual (Proy)</div>
                <div class="dash-value" id="totalYearly">$0</div>
            </div>
        </div>

        <!-- Lista -->
        <div class="sub-list" id="subsList">
            <!-- Items generados por JS -->
        </div>
    </div>

    <!-- Bot贸n Flotante -->
    <button class="fab" onclick="openModal()">
        <i class="fas fa-plus"></i>
    </button>

    <!-- MODAL DE AGREGAR/EDITAR -->
    <div class="modal-overlay" id="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 id="modalTitle">Nueva Suscripci贸n</h2>
                <button onclick="closeModal()" style="background:none; border:none; color:white; font-size:1.5rem;">&times;</button>
            </div>

            <!-- ID oculto para saber si editamos -->
            <input type="hidden" id="subId">

            <!-- Secci贸n 1: Detalles -->
            <div class="form-group">
                <label>Nombre de la Herramienta</label>
                <input type="text" id="sName" placeholder="Ej: Netflix, Adobe...">
            </div>
            
            <div class="form-group row">
                <div>
                    <label>Categor铆a</label>
                    <select id="sCat">
                        <option value="Entretenimiento">Entretenimiento</option>
                        <option value="Trabajo/SaaS">Trabajo/SaaS</option>
                        <option value="Dise帽o">Dise帽o</option>
                        <option value="Infraestructura">Infraestructura</option>
                        <option value="Educaci贸n">Educaci贸n</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div>
                    <label>Website (Login)</label>
                    <input type="text" id="sLink" placeholder="app.com">
                </div>
            </div>

            <!-- Secci贸n 2: Plan y Fechas -->
            <div class="form-group row">
                <div>
                    <label>Estado</label>
                    <select id="sStatus">
                        <option value="Activo">Activo</option>
                        <option value="Prueba">Prueba Gratis</option>
                        <option value="Pausado">Pausado</option>
                    </select>
                </div>
                <div>
                    <label>Ciclo de Pago</label>
                    <select id="sCycle">
                        <option value="Mensual">Mensual</option>
                        <option value="Anual">Anual</option>
                        <option value="Lifetime">Lifetime (1 pago)</option>
                    </select>
                </div>
            </div>

            <div class="form-group row">
                <div>
                    <label>Costo</label>
                    <input type="number" id="sCost" placeholder="0.00">
                </div>
                <div>
                    <label>Moneda</label>
                    <select id="sCurrency">
                        <option value="MXN">MXN</option>
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Pr贸xima Renovaci贸n / Fin de Prueba</label>
                <input type="date" id="sRenewal">
            </div>

            <!-- Secci贸n 3: Seguridad -->
            <hr style="border-color:#333; margin: 20px 0;">
            <p style="font-size:0.8rem; color:var(--accent-purple); margin-bottom:10px;"> Accesos (Encriptado)</p>
            
            <div class="form-group">
                <label>Email de Usuario</label>
                <input type="email" id="sUser" placeholder="admin@empresa.com">
            </div>

            <div class="form-group">
                <label>Contrase帽a</label>
                <div class="pass-wrapper">
                    <input type="password" id="sPass" placeholder="Se guardar谩 encriptada">
                    <button type="button" class="pass-btn" onclick="togglePassVisibility()">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>

            <button class="btn-save" onclick="saveSubscription()">Guardar Suscripci贸n</button>
            
            <div id="editActions" style="display:none;">
                <button class="btn-link" onclick="goToLink()">Ir al sitio web <i class="fas fa-external-link-alt"></i></button>
                <button class="btn-save btn-danger" onclick="deleteSubscription()">Eliminar</button>
            </div>

        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURACIN FIREBASE (Usa la misma de tu otro proyecto)
        // ==========================================
        const firebaseConfig = {
            const firebaseConfig = {
            apiKey: "AIzaSyCUW8mkor6lzFomj2ethMM9sHuMyRuvY_Q",
            authDomain: "appfinanzas-cc8aa.firebaseapp.com",
            projectId: "appfinanzas-cc8aa",
            storageBucket: "appfinanzas-cc8aa.firebasestorage.app",
            messagingSenderId: "621532467032",
            appId: "1:621532467032:web:e7b1ab3f70b970b9839f2d"
        };
        // ==========================================

        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("Firebase conectado");
        } catch (e) { console.error("Error FB", e); }

        let subscriptions = [];
        // PIN MAESTRO SIMPLIFICADO (En una app real, esto no deber铆a estar en el c贸digo cliente, 
        // pero para tu uso personal sirve para evitar miradas indiscretas).
        // LA SEGURIDAD REAL VIENE DE QUE EN LA BD EST ENCRIPTADO.
        let masterPin = ""; 

        // --- MANEJO DE NOTIFICACIONES ---
        function checkNotifications() {
            if (Notification.permission !== "granted") Notification.requestPermission();
            
            const today = new Date();
            subscriptions.forEach(sub => {
                if(sub.status !== 'Activo' && sub.status !== 'Prueba') return;
                
                const renewal = new Date(sub.renewal + 'T00:00:00');
                const diffTime = renewal - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays <= 3 && diffDays >= 0) {
                    let msg = diffDays === 0 ? `HOY vence ${sub.name}` : `${sub.name} vence en ${diffDays} d铆as`;
                    if(sub.status === 'Prueba') msg = ` Fin de prueba: ${msg}`;
                    
                    new Notification("Alerta de Suscripci贸n", { body: msg, icon: getFavicon(sub.link) });
                }
            });
        }

        // --- ESCUCHA DE DATOS (REALTIME) ---
        if (db) {
            db.collection("suscripciones").onSnapshot((querySnapshot) => {
                subscriptions = [];
                querySnapshot.forEach((doc) => {
                    subscriptions.push({ id: doc.id, ...doc.data() });
                });
                renderList();
                calculateTotals();
                checkNotifications();
                document.getElementById('syncStatus').style.background = '#00d26a';
            });
        }

        // --- FUNCIONES DE SEGURIDAD (ENCRIPTACIN) ---
        // Generamos una llave basada en el PIN que pida el usuario al momento de guardar/ver
        // Nota: Para simplificar la UX, aqu铆 usaremos una "Llave Fija" en el c贸digo + PIN de usuario para desencriptar visualmente.
        const SECRET_KEY = "MiLlaveSecretaAppSaaS"; 

        function encryptData(text) {
            if(!text) return "";
            return CryptoJS.AES.encrypt(text, SECRET_KEY).toString();
        }

        function decryptData(ciphertext) {
            if(!ciphertext) return "";
            try {
                const bytes = CryptoJS.AES.decrypt(ciphertext, SECRET_KEY);
                return bytes.toString(CryptoJS.enc.Utf8);
            } catch (e) { return "Error"; }
        }

        // --- RENDERIZADO ---
        function getFavicon(url) {
            if(!url) return 'https://cdn-icons-png.flaticon.com/512/3616/3616927.png'; // Icono default
            // Limpiar URL para obtener solo el dominio
            let domain = url.replace('https://', '').replace('http://', '').split('/')[0];
            return `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;
        }

        function renderList() {
            const list = document.getElementById('subsList');
            list.innerHTML = '';

            // Ordenar por fecha de renovaci贸n m谩s pr贸xima
            let sorted = [...subscriptions].sort((a,b) => new Date(a.renewal) - new Date(b.renewal));

            sorted.forEach(sub => {
                const today = new Date();
                const renewal = new Date(sub.renewal + 'T00:00:00');
                const diffTime = renewal - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                let statusClass = 'st-active';
                let dateText = `Renueva en ${diffDays} d铆as`;

                if(sub.status === 'Prueba') {
                    statusClass = 'st-trial';
                    dateText = `Prueba acaba en ${diffDays} d铆as`;
                } else if(sub.status === 'Pausado') {
                    statusClass = 'st-paused';
                    dateText = 'Pausada';
                }

                if(diffDays < 0) dateText = "Venci贸 hace " + Math.abs(diffDays) + " d铆as";

                const html = `
                    <div class="sub-card" onclick="editSub('${sub.id}')">
                        <img src="${getFavicon(sub.link)}" class="sub-icon" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3616/3616927.png'">
                        <div class="sub-info">
                            <div class="sub-name">${sub.name} <span class="cat-tag">${sub.category}</span></div>
                            <div class="sub-details">
                                <span class="status-dot ${statusClass}"></span> ${dateText}
                            </div>
                        </div>
                        <div style="text-align:right">
                            <div class="sub-cost">$${sub.cost} ${sub.currency}</div>
                            <span class="sub-cycle">${sub.cycle}</span>
                        </div>
                    </div>
                `;
                list.innerHTML += html;
            });
        }

        function calculateTotals() {
            let monthlyTotal = 0;
            let yearlyTotal = 0;

            subscriptions.forEach(sub => {
                if(sub.status === 'Pausado') return;

                let cost = parseFloat(sub.cost);
                // Convertir todo a una moneda base (simple: asumimos 1:1 o mostramos suma directa si es la misma)
                // Para V1 sumaremos valor num茅rico ignorando divisa para no complicar con API de cambio
                
                if(sub.cycle === 'Mensual') {
                    monthlyTotal += cost;
                    yearlyTotal += (cost * 12);
                } else if (sub.cycle === 'Anual') {
                    monthlyTotal += (cost / 12);
                    yearlyTotal += cost;
                }
            });

            document.getElementById('totalMonthly').innerText = `$${monthlyTotal.toFixed(2)}`;
            document.getElementById('totalYearly').innerText = `$${yearlyTotal.toFixed(2)}`;
        }

        // --- LGICA DEL FORMULARIO ---
        function openModal(isEdit = false) {
            const modal = document.getElementById('modal');
            modal.style.display = 'flex';
            if(!isEdit) {
                document.getElementById('subId').value = '';
                document.getElementById('modalTitle').innerText = "Nueva Suscripci贸n";
                // Limpiar campos
                ['sName', 'sCat', 'sLink', 'sCost', 'sRenewal', 'sUser', 'sPass'].forEach(id => document.getElementById(id).value = '');
                document.getElementById('sCycle').value = 'Mensual';
                document.getElementById('sCurrency').value = 'MXN';
                document.getElementById('editActions').style.display = 'none';
            }
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        function saveSubscription() {
            const id = document.getElementById('subId').value;
            const data = {
                name: document.getElementById('sName').value,
                category: document.getElementById('sCat').value,
                link: document.getElementById('sLink').value,
                status: document.getElementById('sStatus').value,
                cycle: document.getElementById('sCycle').value,
                cost: document.getElementById('sCost').value,
                currency: document.getElementById('sCurrency').value,
                renewal: document.getElementById('sRenewal').value,
                user: document.getElementById('sUser').value,
                // AQU OCURRE LA MAGIA DE SEGURIDAD:
                // Si el campo tiene valor, lo encriptamos. Si est谩 vac铆o (en edici贸n), mantenemos el anterior.
            };
            
            const rawPass = document.getElementById('sPass').value;
            if(rawPass) {
                data.pass = encryptData(rawPass); // SE GUARDA ENCRIPTADO
            }

            if(!data.name || !data.cost || !data.renewal) return alert("Completa los campos b谩sicos");

            if(id) {
                // Actualizar
                // Si no puso password nueva, no sobrescribimos el campo pass para no borrarlo
                if(!rawPass) delete data.pass; 
                db.collection("suscripciones").doc(id).update(data);
            } else {
                // Crear
                db.collection("suscripciones").add(data);
            }
            closeModal();
        }

        function editSub(id) {
            const sub = subscriptions.find(s => s.id === id);
            if(!sub) return;

            document.getElementById('subId').value = sub.id;
            document.getElementById('modalTitle').innerText = "Editar " + sub.name;
            
            document.getElementById('sName').value = sub.name;
            document.getElementById('sCat').value = sub.category;
            document.getElementById('sLink').value = sub.link;
            document.getElementById('sStatus').value = sub.status;
            document.getElementById('sCycle').value = sub.cycle;
            document.getElementById('sCost').value = sub.cost;
            document.getElementById('sCurrency').value = sub.currency;
            document.getElementById('sRenewal').value = sub.renewal;
            document.getElementById('sUser').value = sub.user || '';
            document.getElementById('sPass').value = ''; // No mostramos el hash encriptado por UX
            document.getElementById('sPass').placeholder = "********** (Oculta)";

            // Guardamos la pass encriptada en un atributo temporal por si quiere verla
            document.getElementById('sPass').dataset.enc = sub.pass || '';

            document.getElementById('editActions').style.display = 'block';
            openModal(true);
        }

        function deleteSubscription() {
            const id = document.getElementById('subId').value;
            if(confirm("驴Eliminar esta suscripci贸n?")) {
                db.collection("suscripciones").doc(id).delete();
                closeModal();
            }
        }

        function goToLink() {
            let url = document.getElementById('sLink').value;
            if(url) {
                if(!url.startsWith('http')) url = 'https://' + url;
                window.open(url, '_blank');
            }
        }

        // --- SEGURIDAD: VER CONTRASEA ---
        function togglePassVisibility() {
            const passInput = document.getElementById('sPass');
            const encrypted = passInput.dataset.enc;
            
            // Si el campo es type password, queremos mostrarla
            if(passInput.type === "password") {
                if(!encrypted && !passInput.value) return alert("No hay contrase帽a guardada");
                
                // Pedimos PIN para desencriptar
                const userPin = prompt(" SEGURIDAD: Ingresa tu PIN de acceso para desencriptar:");
                // Aqu铆 podr铆as validar contra un PIN fijo, ej: if(userPin === "1234")
                // Pero para este ejemplo, asumiremos que si tiene acceso al dispositivo, tiene permiso.
                
                if(userPin) {
                    if(passInput.value) {
                         // Es una nueva que est谩 escribiendo
                         passInput.type = "text";
                    } else {
                        // Es la guardada, hay que desencriptar
                        const decrypted = decryptData(encrypted);
                        passInput.value = decrypted;
                        passInput.type = "text";
                    }
                }
            } else {
                passInput.type = "password";
                if(!passInput.dataset.new) passInput.value = ""; // Ocultar de nuevo
            }
        }
    </script>
</body>
</html>
